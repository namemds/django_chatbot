<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>Robot Chat</title>
    <link rel="stylesheet" href="{% static 'element-ui/lib/theme-chalk/index.css' %}">
    <script src="{% static 'js/vue.js' %}"></script>
    <script src="{% static 'element-ui/lib/index.js' %}"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100vw;
            height: 100vh;
            background: #050505;
        }

        #app {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
            color: #0ff;
        }

        .sidebar {
            width: 260px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-right: 2px solid #0ff;
            display: flex;
            flex-direction: column;
            height: 100%;
        }


        .button-container {
            margin-top: auto; /* â¬…ï¸ è‡ªåŠ¨æ¨åˆ°åº•éƒ¨ */
            padding: 0 0 15px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .button-container .el-button {
            width: 100% !important;      /* å¼ºåˆ¶å æ»¡å®¹å™¨å®½åº¦ */
            margin: 0 !important;        /* ç§»é™¤é»˜è®¤é—´è· */
            padding-left: 0 !important;  /* ç¡®ä¿å·¦å³å¯¹é½ */
            padding-right: 0 !important;
            box-sizing: border-box;
        }


        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: transparent;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #00eaff;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 16px;
            max-width: 100%;
            padding: 10px 15px;
            border-radius: 12px;
            line-height: 1.5;
            box-shadow: 0 0 8px rgba(0,255,255,0.2);
            position: relative;
        }
        .message.user::after {
            content: "";
            position: absolute;
            right: -10px;
            top: 12px;
            border-width: 6px 0 6px 10px;
            border-style: solid;
            border-color: transparent transparent transparent #00fff7;
        }

        .message.bot::after {
            content: "";
            position: absolute;
            left: -10px;
            top: 12px;
            border-width: 6px 10px 6px 0;
            border-style: solid;
            border-color: transparent #8e44ad transparent transparent;
        }


        .user {
            background: linear-gradient(to right, #0ff, #00eaff);
            color: #000;
            align-self: flex-end;
            text-align: right;
        }

        .bot {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: #fff;
            align-self: flex-start;
        }

        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-area .el-textarea__inner {
            background: #0f0f0f;
            border: 1px solid #00fff7;
            color: #00fff7;
            box-shadow: 0 0 10px #00fff7;
        }

        .full-width-btn {
            width: 100%;
            box-sizing: border-box;
        }

        .el-button {
            background: #00fff7;
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 10px #00fff7;
        }

        .el-menu {
            background: transparent;
            flex: 1; /* è®©èœå•å æ®å‰©ä½™ç©ºé—´ */
            overflow-y: auto; /* å¦‚æœèœå•é¡¹è¿‡å¤šå¯ä»¥æ»šåŠ¨ */
        }

        .el-menu-item {
            color: #0ff;
        }

        .el-menu-item:hover,
        .el-menu-item.is-active {
            background: rgba(0, 255, 255, 0.1);
            color: #fff;
        }

        /* æ•´ä½“æ»šåŠ¨æ¡åŒºåŸŸ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        /* æ»šåŠ¨æ¡è½¨é“ */
        ::-webkit-scrollbar-track {
            background: rgba(0, 255, 255, 0.05); /* æ·¡è“è½¨é“ */
            border-radius: 4px;
        }

        /* æ»šåŠ¨æ¡æ»‘å— */
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00fff7, #007bff);
            border-radius: 8px;
            box-shadow: 0 0 6px #00fff7;
        }

        /* é¼ æ ‡æ‚¬åœåœ¨æ»‘å—ä¸Šæ—¶ */
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00fff7, #0055ff);
        }

    </style>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<div id="app">
    <div class="sidebar">
        <el-button type="primary" icon="el-icon-plus" size="mini" @click="newConversation" style="width: 100%; margin-bottom: 20px;">
            æ–°å¯¹è¯
        </el-button>

        {% verbatim %}
        <el-menu v-if="currentConvId !== null" :default-active="currentConvId ? currentConvId.toString() : ''" @select="selectConversation">
            <el-menu-item v-for="(conv, index) in conversations" :key="conv.id" :index="conv.id.toString()" style="display: flex; justify-content: space-between; align-items: center;">
                <i class="el-icon-message" style="margin-right: 5px;"></i> å¯¹è¯ {{ index + 1 }}
                <el-button type="text" icon="el-icon-delete" size="mini" @click.stop="deleteConversation(conv.id)" style="color: #ed0404;"></el-button>
            </el-menu-item>
        </el-menu>

        {% endverbatim %}

        <div class="button-container">
            <el-button type="danger" size="mini" icon="el-icon-switch-button"
                       @click="logout" class="full-width-btn">
                é€€å‡ºç™»å½•
            </el-button>
            <el-button type="warning" size="mini" icon="el-icon-delete"
                       @click="deleteAccount" class="full-width-btn">
                æ³¨é”€è´¦æˆ·
            </el-button>
        </div>
    </div>

    <div class="chat-container">
        {% verbatim %}
        <div class="messages">
            <div v-for="msg in currentMessages" :key="msg.id" :class="['message', msg.sender]">
                <strong>{{ msg.sender === 'user' ? 'ä½ ' : 'ğŸ¤–ğŸ˜' }}:</strong><br>
                {{ msg.text }}
            </div>
        </div>
        <div class="input-area">
            <el-input type="textarea" placeholder="è¯¢é—®ä»»ä½•é—®é¢˜" v-model="inputText" rows="2" @keyup.enter.native="sendMessage"></el-input>
            <el-button
                    icon="el-icon-sent"
                    @click="sendMessage"
                    :disabled="!inputText.trim() || isReplying"
                    :loading="isReplying">
                å‘é€
            </el-button>
        </div>
        {% endverbatim %}
    </div>
</div>

<script>
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particlesArray = [];

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        initParticles();
    });

    class Particle {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 2 + 1;
            this.speedX = Math.random() * 1 - 0.5;
            this.speedY = Math.random() * 1 - 0.5;
        }

        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
            if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = '#00f0ff';
            ctx.fill();
        }
    }

    function initParticles() {
        particlesArray = [];
        let numberOfParticles = (canvas.width * canvas.height) / 10000;
        for (let i = 0; i < numberOfParticles; i++) {
            particlesArray.push(new Particle());
        }
    }

    function connectParticles() {
        for (let a = 0; a < particlesArray.length; a++) {
            for (let b = a + 1; b < particlesArray.length; b++) {
                let dx = particlesArray[a].x - particlesArray[b].x;
                let dy = particlesArray[a].y - particlesArray[b].y;
                let distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 120) {
                    ctx.strokeStyle = `rgba(0,255,255,${1 - distance / 120})`;
                    ctx.lineWidth = 0.6;
                    ctx.beginPath();
                    ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                    ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                    ctx.stroke();
                }
            }
        }
    }

    function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update();
            particlesArray[i].draw();
        }
        connectParticles();
        requestAnimationFrame(animateParticles);
    }

    initParticles();
    animateParticles();
</script>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                userId: null,
                conversations: [],
                currentConvId: null,
                inputText: '',
                isReplying: false,
            };
        },
        computed: {
            currentConversation() {
                return this.conversations.find(c => c.id === this.currentConvId);
            },
            currentMessages() {
                return this.currentConversation ? this.currentConversation.messages : [];
            }
        },
        created() {
            const userId = sessionStorage.getItem("user_id");
            if (!userId) {
                window.location.href = "/login/";
                return;
            }

            this.userId = userId;

            fetch(`/api/get_conversations/?user_id=${userId}`)
                .then(res => res.json())
                .then(data => {
                    this.conversations = data.conversations.map(c => ({
                        id: c.id,
                        username: c.username,
                        messages: []
                    }));
                    // å¦‚æœä¼šè¯åˆ—è¡¨ä¸ºç©ºï¼Œè‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯
                    if (this.conversations.length === 0) {
                        this.newConversation();
                    } else {
                        // å¦åˆ™åŠ è½½ç¬¬ä¸€ä¸ªä¼šè¯
                        this.currentConvId = this.conversations[0].id;
                        this.loadMessages(this.currentConvId);
                    }
                });
        },

        methods: {
            loadMessages(convId) {
                fetch(`/api/get_messages/?conversation_id=${convId}`)
                    .then(res => res.json())
                    .then(data => {
                        const conv = this.conversations.find(c => c.id === convId);
                        if (conv) {
                            conv.messages = data.messages.map((m, i) => ({
                                id: i + 1,
                                sender: m.sender,
                                text: m.text
                            }));
                            this.currentConvId = convId;
                        }
                    });
            },
            selectConversation(id) {
                this.loadMessages(parseInt(id));
            },
            sendMessage() {
                if (!this.inputText.trim()) return;

                const userMsg = { sender: 'user', text: this.inputText };
                const botMsg = { sender: 'bot', text: '' };
                this.currentConversation.messages.push(userMsg, botMsg);
                this.scrollToBottom(); // ğŸ‘ˆ åŠ è¿™ä¸€è¡Œ


                this.isReplying = true; // ğŸ‘ˆ è®¾ç½®ä¸ºæ­£åœ¨å›å¤

                fetch('/api/send_message/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversation_id: this.currentConvId,
                        text: this.inputText
                    })
                })
                    .then(res => {
                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();

                        const read = () => {
                            return reader.read().then(({ done, value }) => {
                                if (done) {
                                    this.isReplying = false; // âœ… ç»“æŸåæ¢å¤
                                    return;
                                }
                                botMsg.text += decoder.decode(value, { stream: true });
                                this.$forceUpdate();
                                this.scrollToBottom(); // ğŸ‘ˆ åŠ è¿™ä¸€è¡Œ
                                return read();
                            });
                        };

                        return read();
                    });

                this.inputText = '';
            },

            newConversation() {
                fetch("/api/create_conversation/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: this.userId })
                })
                    .then(res => res.json())
                    .then(data => {
                        const newConv = {
                            id: data.conversation_id,
                            username: '',
                            messages: []
                        };
                        this.conversations.push(newConv);
                        this.currentConvId = newConv.id;
                        this.loadMessages(newConv.id); // åŠ è½½æ–°ä¼šè¯çš„æ¶ˆæ¯
                    });
            },
            logout() {
                sessionStorage.removeItem("user_id");
                window.location.href = "/login/";
            },
            deleteAccount() {
                this.$confirm('ç¡®å®šè¦æ³¨é”€è´¦æˆ·å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•å¹¶æ— æ³•æ¢å¤ã€‚', 'è­¦å‘Š', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(() => {
                    fetch("/api/delete_user/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user_id: this.userId })
                    })
                        .then(res => res.json())
                        .then(data => {
                            this.$message.success("è´¦æˆ·å·²æ³¨é”€");
                            sessionStorage.removeItem("user_id");
                            window.location.href = "/login/";
                        });
                }).catch(() => {});
            },
            deleteConversation(convId) {
                this.$confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¯¹è¯å—ï¼Ÿæ“ä½œä¸å¯æ’¤é”€ã€‚', 'æç¤º', {
                    confirmButtonText: 'åˆ é™¤',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(() => {
                    fetch("/api/delete_conversation/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ conversation_id: convId })
                    })
                        .then(res => res.json())
                        .then(() => {
                            this.conversations = this.conversations.filter(c => c.id !== convId);
                            if (this.currentConvId === convId) {
                                this.currentConvId = this.conversations.length ? this.conversations[0].id : null;
                            }
                        });
                }).catch(() => {});
            },
            scrollToBottom() {
                this.$nextTick(() => {
                    const container = this.$el.querySelector('.messages');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                });
            }


        }
    });
</script>

</body>
</html> 